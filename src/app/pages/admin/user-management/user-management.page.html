<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-button (click)="goBack()">
        <ion-icon slot="icon-only" name="arrow-back-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-title>User Management</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">
  <!-- Search and Filter Controls -->
  <ion-grid>
    <ion-row>
      <ion-col size="12" size-md="6">
        <ion-searchbar 
          [(ngModel)]="searchTerm"
          (ionInput)="applyFilters()"
          placeholder="Search by name or email">
        </ion-searchbar>
      </ion-col>
      <ion-col size="12" size-md="6">
        <ion-item>
          <ion-select 
            [(ngModel)]="selectedRole"
            (ionChange)="applyFilters()"
            placeholder="Filter by role">
            <ion-select-option value="">All Roles</ion-select-option>
            @for (role of roles; track role) {
              <ion-select-option [value]="role">{{role}}</ion-select-option>
            }
          </ion-select>
        </ion-item>
      </ion-col>
    </ion-row>
  </ion-grid>

  <!-- Users List -->
  <ion-list>
    @for (user of filteredUsers; track user.id) {
      <ion-item button (click)="openUserDetails(user)">
        <ion-grid>
          <ion-row class="ion-align-items-center">
            <ion-col size="12" size-md="3">
              <div class="user-info">
                @if (user.profileImage) {
                  <ion-avatar>
                    <img [src]="user.profileImage" alt="Profile">
                  </ion-avatar>
                } @else {
                  <ion-icon name="person-outline" class="default-avatar"></ion-icon>
                }
                <div class="user-name">
                  {{ user.firstName }} {{ user.lastName }}
                </div>
              </div>
            </ion-col>
            <ion-col size="12" size-md="3">
              <ion-text color="medium">
                <ion-icon name="mail-outline"></ion-icon>
                {{ user.email }}
              </ion-text>
            </ion-col>
            <ion-col size="6" size-md="2">
              <ion-chip [color]="user.role === 'admin' ? 'primary' : 'success'">
                {{ user.role }}
              </ion-chip>
            </ion-col>
            <ion-col size="6" size-md="2">
              <ion-text color="medium" class="ion-text-nowrap">
                <ion-icon name="calendar-outline"></ion-icon>
                {{ formatDate(user.createdAt) }}
              </ion-text>
            </ion-col>
            <ion-col size="12" size-md="2">
              <div class="action-buttons">
                <ion-button fill="clear" color="primary" (click)="updateUserRole(user); $event.stopPropagation()">
                  <ion-icon name="create-outline"></ion-icon>
                </ion-button>
                <ion-button fill="clear" color="danger" (click)="deleteUser(user.id); $event.stopPropagation()">
                  <ion-icon name="trash-outline"></ion-icon>
                </ion-button>
              </div>
            </ion-col>
          </ion-row>
        </ion-grid>
      </ion-item>
    }
  </ion-list>

  <!-- User Details Modal -->
  <ion-modal [isOpen]="isModalOpen" (didDismiss)="closeModal()">
    @if (selectedUser) {
      <ion-header>
        <ion-toolbar>
          <ion-title>User Details</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="closeModal()">Close</ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>

      <ion-content class="ion-padding">
        <ion-card>
          <ion-card-content>
            <ion-grid>
              <ion-row>
                <!-- Profile Image -->
                <ion-col size="12" class="ion-text-center">
                  @if (selectedUser.profileImage) {
                    <img [src]="selectedUser.profileImage" alt="Profile" class="profile-image">
                  } @else {
                    <ion-icon name="person-outline" class="large-avatar"></ion-icon>
                  }
                </ion-col>

                <!-- User Information -->
                <ion-col size="12">
                  <ion-list>
                    <ion-item>
                      <ion-label>
                        <h2>Full Name</h2>
                        <p>{{ selectedUser.firstName }} {{ selectedUser.lastName }}</p>
                      </ion-label>
                    </ion-item>

                    <ion-item>
                      <ion-label>
                        <h2>Email</h2>
                        <p>{{ selectedUser.email }}</p>
                      </ion-label>
                    </ion-item>

                    <ion-item>
                      <ion-label>
                        <h2>Contact Number</h2>
                        <p>{{ selectedUser.contactNumber || 'Not provided' }}</p>
                      </ion-label>
                    </ion-item>

                    <ion-item>
                      <ion-label>
                        <h2>Address</h2>
                        <p>{{ selectedUser.address || 'Not provided' }}</p>
                      </ion-label>
                    </ion-item>

                    <ion-item>
                      <ion-label>
                        <h2>Role</h2>
                        <ion-chip [color]="selectedUser.role === 'admin' ? 'primary' : 'success'">
                          {{ selectedUser.role }}
                        </ion-chip>
                      </ion-label>
                    </ion-item>

                    <ion-item>
                      <ion-label>
                        <h2>Last Login</h2>
                        <p>{{ selectedUser.lastLogin ? formatDate(selectedUser.lastLogin) : 'Never' }}</p>
                      </ion-label>
                    </ion-item>

                    <ion-item>
                      <ion-label>
                        <h2>Account Created</h2>
                        <p>{{ formatDate(selectedUser.createdAt) }}</p>
                      </ion-label>
                    </ion-item>
                  </ion-list>
                </ion-col>
              </ion-row>
            </ion-grid>
          </ion-card-content>
        </ion-card>
      </ion-content>
    }
  </ion-modal>
</ion-content>